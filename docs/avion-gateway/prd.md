# PRD: avion-gateway

## 概要

AvionマイクロサービスアーキテクチャにおけるAPIゲートウェイを実装する。

## 背景

マイクロサービスアーキテクチャを採用するにあたり、BFF (`avion-bff-web`) や将来的な外部クライアントからのリクエストを集約し、適切なバックエンドサービスへルーティングする単一のエントリーポイントが必要となる。また、認証 (`avion-user` と連携)、認可 (`avion-authz` と連携)、レートリミット、ログ集約などの共通機能を一元管理することで、各マイクロサービスの責務を明確にし、開発効率と運用性を向上させる。

## Scientific Merits

*   **開発効率の向上:** 認証連携、認可チェック、レートリミットなどの共通処理をゲートウェイに集約することで、各マイクロサービスでの実装が不要になり、開発工数を削減できる。
*   **運用性の向上:** リクエストのログやメトリクスをゲートウェイで一元管理することで、監視やトラブルシューティングが容易になる。
*   **セキュリティの強化:** 認証・認可チェックをゲートウェイで強制することで、セキュリティポリシーを一貫して適用できる。
*   **柔軟性の向上:** バックエンドサービスの構成変更（追加、削除、バージョンアップ）をゲートウェイ側で吸収でき、クライアントへの影響を最小限に抑えられる。

定量的なメリットの算出は現時点では難しいが、マイクロサービスアーキテクチャにおけるベストプラクティスであり、上記のような定性的なメリットは大きいと考えられる。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)

## 製品原則

*   **単一のエントリーポイント:** 全てのクライアントリクエストの窓口となる。
*   **効率的なルーティング:** 認証・認可されたリクエストを適切なバックエンドサービスへ高速かつ確実に転送する。
*   **共通機能の集約:** 認証連携、認可チェック、レートリミットなどの横断的関心事を一元的に処理する。

## やること/やらないこと

### やること

*   フロントエンド (avion-web) からのリクエスト受信とバックエンドサービスへのルーティング
*   ActivityPubクライアントからのリクエスト受信とバックエンドサービスへのルーティング (将来的な拡張)
*   リクエスト/レスポンスのログ記録
*   認証連携 (`avion-user` と連携、JWT検証、Bot認証など)
*   認可チェック (`avion-authz` と連携)
*   レートリミット
*   基本的なメトリクス (リクエスト数、レイテンシなど) の収集
*   OpenTelemetryトレースコンテキストの伝播

### やらないこと

*   **複雑なビジネスロジックの実装:** ゲートウェイはルーティングと共通処理に専念し、ビジネスロジックは各マイクロサービスが担当する。
*   **データの永続化:** 状態を持たず、データの保存は行わない。
*   **サービスディスカバリの複雑な実装:** 初期段階では静的なルーティング設定を基本とする (将来的にConsul等との連携も検討可能)。

## 対象ユーザ

*   Avion Web BFF (`avion-bff-web`)
*   (将来的に) サードパーティクライアント / 他のBFF
*   Avion 開発者・運用者

## ユースケース

### BFFからのAPIリクエスト (人間ユーザー経由)

1.  `avion-bff-web` は、`avion-web` からのリクエストを受け、必要なバックエンドサービスへのAPIリクエストを `avion-gateway` に送信する (通常、ユーザーの認証情報を含むヘッダーを付与)。
2.  `avion-gateway` は認証情報 (例: JWT) を検証する (`avion-user` と連携)。
3.  認証成功後、ユーザーIDやスコープ情報を取得する。
4.  `avion-gateway` はリクエストされた操作に必要な権限を判断し、`avion-authz` に認可判定リクエストを送信する。
5.  `avion-authz` から許可応答を受け取る。
6.  リクエストパスに基づいて適切なバックエンドサービスを特定する。
7.  レートリミットを確認する。
8.  リクエストを該当するバックエンドサービスに転送する (ユーザーIDなどの認証情報をヘッダーで渡す)。
9.  バックエンドサービスからのレスポンスを受け取り、`avion-bff-web` に返す。
10. リクエストとレスポンスに関する情報をログに記録する。

### BotユーザーからのAPIリクエスト

1.  BotアプリケーションはAPIキー/シークレット等を用いて `avion-gateway` (または専用エンドポイント) にアクセストークンを要求する (Client Credentials Flowなど)。
2.  `avion-gateway` は `avion-user` または `avion-authz` と連携して認証を行い、Botユーザーに対応するアクセストークン (スコープ情報を含む) を発行する。
3.  Botアプリケーションは取得したアクセストークンをAuthorizationヘッダーに含めてAPIリクエストを `avion-gateway` に送信する。
4.  `avion-gateway` はアクセストークンを検証する。
5.  認証成功後、トークンからBotユーザーIDやスコープ情報を取得する。
6.  `avion-gateway` はリクエストされた操作に必要な権限とトークン内のスコープを照合し、`avion-authz` に認可判定リクエストを送信する。
7.  以降は人間ユーザーの場合と同様に、認可判定、ルーティング、レートリミット確認、転送を行う。

(UIモックは直接的には存在しないが、シーケンス図などで表現可能)

### 認証/認可失敗

1.  `avion-bff-web` または他のクライアントからのリクエストに含まれる認証情報が無効、または存在しない。
2.  `avion-gateway` は認証エラー (例: 401 Unauthorized) を呼び出し元 (BFFなど) に返す。
3.  認証は成功したが、`avion-authz` による認可チェックで拒否された。
4.  `avion-gateway` は認可エラー (例: 403 Forbidden) を呼び出し元 (BFFなど) に返す。

### レートリミット超過

1.  特定のクライアント (BFF経由のユーザー or Bot) からのリクエスト数が設定された閾値を超えた。
2.  `avion-gateway` はレートリミット超過エラー (例: 429 Too Many Requests) を呼び出し元 (BFFなど) に返す。

## 機能要求

*   **ルーティング:** パスベースの静的なルーティング設定が可能であること。設定は設定ファイルまたは環境変数で行えること。
*   **認証連携:** JWT検証機能を持つこと。Botユーザー向けの認証フロー (Client Credentials等) をサポートすること (`avion-user`/`avion-authz` と連携)。
*   **認可連携:** バックエンドサービスへのリクエスト転送前に、`avion-authz` サービスに認可判定を問い合わせる機能を持つこと。
*   **レートリミット:** IPアドレスまたは認証ユーザーIDに基づいたレートリミット機能を持つこと。閾値は設定可能であること。
*   **ロギング:** リクエストメソッド、パス、ステータスコード、処理時間、クライアントIPアドレス、ユーザーIDなどを構造化ログ (JSON形式など) で出力できること。
*   **メトリクス:** Prometheus形式で基本的なメトリクス (リクエスト総数、エラー数、レイテンシのヒストグラムなど) を公開するエンドポイントを持つこと。

## 技術的要求

### レイテンシ

*   ゲートウェイ自身の処理による追加レイテンシは、平均 50ms 以下を目指す。

### 可用性

*   Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。
*   バックエンドサービスの一部がダウンしても、他の正常なサービスへのルーティングは継続できること。

### セキュリティ

*   HTTPS通信を強制すること (TLS終端はゲートウェイで行うか、手前のIngress Controller/ロードバランサーで行うかは別途検討)。
*   不正なリクエストヘッダーやボディサイズに対する防御策を持つこと。
*   依存ライブラリの脆弱性管理を行うこと。

### その他技術要件

*   **ステートレス:** ゲートウェイ自体は状態を持たず、水平スケールが可能であること。設定は設定ファイルや環境変数、ConfigMapなどから読み込む。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。トレースコンテキストをバックエンドサービスに伝播すること。

## 決まっていないこと

*   認証方式の詳細 (JWTの具体的な実装、鍵管理方法)
*   レートリミットの具体的なアルゴリズムと閾値
*   TLS終端をどこで行うか (ゲートウェイ or ロードバランサー)
*   サービスディスカバリの将来的な導入方式
