# Avion テスト戦略実装計画書

作成日: 2025-08-14

## 1. エグゼクティブサマリー

本文書は、Avionプロジェクトの全マイクロサービスに対して、サービス固有のテスト戦略を実装するための計画書です。共通テスト戦略は既に包括的に定義されているため、各サービス特有の技術的課題に対応するテスト要件を追加します。

## 2. 実装状況

### 2.1 完了済み（Phase 1）

| サービス | 完了日 | 追加行数 | 主な焦点 |
|---------|-------|---------|---------|
| avion-auth | 2025-08-14 | 580行 | 認証フロー、MFA、セキュリティテスト |
| avion-gateway | 2025-08-14 | 400行 | GraphQL、レート制限、サーキットブレーカー |
| avion-drop | 2025-08-14 | 380行 | コンテンツ管理、リアクション、ポーリング |
| avion-timeline | 2025-08-14 | 415行 | ファンアウト、SSE、キャッシング |

### 2.2 実装予定（Phase 2）

優先度順に以下のサービスに実装予定：

## 3. Phase 2 実装テンプレート

残りのサービスに対して、以下のテンプレートに基づいて実装します：

### 3.1 avion-notification

```markdown
## X. サービス固有のテスト戦略

### X.1 WebPush/SSE配信テスト
- WebPush暗号化（RFC 8291準拠）のテスト
- VAPID署名の生成と検証
- SSE接続プールの管理
- プッシュ通知の失敗とリトライ
- エンドポイント無効化の検出

### X.2 イベント駆動処理テスト
- Redis Streamからのイベント消費
- イベントの重複排除（イデンポテンシー）
- 配信優先度管理
- バッチ通知の集約

### X.3 負荷テスト
- 100万SSE接続の同時管理
- WebPush配信スループット（10,000/秒）
```

### 3.2 avion-media

```markdown
## X. サービス固有のテスト戦略

### X.1 メディア処理パイプラインテスト
- 画像リサイズ・圧縮
- 動画トランスコーディング
- サムネイル生成
- EXIF情報の削除
- ウイルススキャン統合

### X.2 S3統合テスト
- マルチパートアップロード
- プリサインURL生成
- CDN無効化
- オブジェクトライフサイクル

### X.3 非同期タスク処理
- Redis Streamタスクキュー
- 処理失敗時のリトライ
- Dead Letter Queue処理
```

### 3.3 avion-search

```markdown
## X. サービス固有のテスト戦略

### X.1 MeiliSearch統合テスト
- インデックス作成・更新
- 検索クエリ最適化
- ファセット検索
- タイポトレランス
- 同義語処理

### X.2 プライバシー制御テスト
- 検索可能コンテンツ設定
- ブロック/ミュートフィルタリング
- GDPR準拠（忘れられる権利）

### X.3 インデックス同期テスト
- イベント駆動インデックス更新
- バッチインデックス処理
- インデックス一貫性検証
```

### 3.4 avion-activitypub

```markdown
## X. サービス固有のテスト戦略

### X.1 連合プロトコルテスト
- HTTP署名の生成と検証
- Activity検証（JSON-LD）
- WebFingerディスカバリー
- Actor情報の取得とキャッシュ

### X.2 相互運用性テスト
- Mastodon互換性
- Misskey互換性
- Pleroma互換性
- 不明なActivityの処理

### X.3 配信管理テスト
- Outbox配信キュー
- 配信失敗とリトライ
- ドメインブロック
- レート制限対応
```

### 3.5 avion-moderation

```markdown
## X. サービス固有のテスト戦略

### X.1 コンテンツフィルタリングテスト
- AI/MLモデル統合（プライバシー保護）
- キーワードフィルタリング
- 画像/動画コンテンツ分析
- フィルタリング精度測定

### X.2 モデレーションワークフロー
- レポート処理フロー
- エスカレーション判定
- アピール処理
- 自動アクション実行

### X.3 監査証跡テスト
- ハッシュチェーン整合性
- タンパーエビデンス検出
- コンプライアンスレポート生成
```

### 3.6 avion-system-admin

```markdown
## X. サービス固有のテスト戦略

### X.1 管理操作テスト
- 危険操作の承認フロー
- 一括操作のトランザクション
- 設定変更の伝播
- ロールバック機能

### X.2 モニタリング統合
- メトリクス収集（Prometheus）
- アラート発火条件
- ダッシュボード更新
- SLI/SLO計測

### X.3 バックアップ/リストア
- 増分バックアップ
- ポイントインタイムリカバリ
- クロスリージョンレプリケーション
```

### 3.7 avion-community

```markdown
## X. サービス固有のテスト戦略

### X.1 コミュニティ管理テスト
- 階層的ロール権限
- 招待リンク生成と有効期限
- メンバー承認フロー
- コミュニティルール違反検出

### X.2 イベント管理テスト
- リカーリングイベント
- 参加者管理
- リマインダー通知
- タイムゾーン処理

### X.3 トピック管理
- スレッド型ディスカッション
- ピン留め/アーカイブ
- 検索インデックス統合
```

### 3.8 avion-user

```markdown
## X. サービス固有のテスト戦略

### X.1 ソーシャルグラフテスト
- フォロー/フォロワー関係
- ブロック/ミュート伝播
- 相互フォロー検出
- グラフトラバーサル性能

### X.2 プロファイル管理
- カスタムフィールド検証
- アバター/ヘッダー画像処理
- プライバシー設定継承
- 検証バッジ管理

### X.3 設定同期テスト
- クロスデバイス同期
- 設定エクスポート/インポート
- デフォルト値の継承
```

### 3.9 avion-web (フロントエンド)

```markdown
## X. サービス固有のテスト戦略

### X.1 GraphQL統合テスト
- Apollo Clientモック
- オプティミスティック更新
- キャッシュ無効化
- エラーバウンダリー

### X.2 PWAテスト
- Service Worker更新
- オフライン動作
- プッシュ通知受信
- インストールフロー

### X.3 パフォーマンステスト
- Core Web Vitals測定
- バンドルサイズ監視
- コード分割効果
- 仮想スクロール性能
```

## 4. 実装スケジュール

### Phase 2（1週間）
- Day 1-2: avion-notification, avion-media
- Day 3-4: avion-search, avion-activitypub
- Day 5: avion-moderation, avion-system-admin
- Day 6: avion-community, avion-user
- Day 7: avion-web, レビュー

### Phase 3（3日間）
- Day 1: 全サービスのテスト戦略レビュー
- Day 2: CI/CD統合設定の更新
- Day 3: ドキュメント最終化

## 5. 成功基準

### 定量的指標
- [ ] 全13サービスにサービス固有テスト戦略セクション追加
- [ ] 各サービス最低300行の具体的なテストコード例
- [ ] 全サービスで以下のカバレッジ目標設定
  - ユニットテスト: 90%以上
  - クリティカルパス: 95%以上
  - 統合テスト: 80%以上

### 定性的指標
- [ ] 各サービスの技術的特性を反映したテスト
- [ ] 具体的で実行可能なGoコード例
- [ ] CI/CDパイプラインとの統合考慮
- [ ] パフォーマンスベンチマーク定義

## 6. リスクと対策

### リスク1: 実装工数の増大
**対策**: テンプレートを活用し、共通パターンを再利用

### リスク2: テスト実行時間の増加
**対策**: 並列実行とテストの階層化（unit/integration/e2e）

### リスク3: メンテナンス負荷
**対策**: テストヘルパーとユーティリティの共通化

## 7. 次のステップ

### 即時実行（今日中）
1. ✅ Phase 1完了（4サービス）
2. ⬜ Phase 2テンプレート承認
3. ⬜ 実装チーム割り当て

### 今週中
1. ⬜ Phase 2実装（9サービス）
2. ⬜ CI/CD設定更新
3. ⬜ レビューと承認

### 来週
1. ⬜ 全サービステスト実装開始
2. ⬜ 初期テストカバレッジ測定
3. ⬜ 改善点の特定と対応

## 8. 推奨事項

### 優先実装
1. **クリティカルパス**: 認証、コンテンツ作成、タイムライン表示
2. **高リスク領域**: セキュリティ、データ整合性、パフォーマンス
3. **外部依存**: サードパーティAPI、外部サービス統合

### ベストプラクティス
1. **TDD厳守**: テスト→実装の順序を守る
2. **モック最小化**: 必要最小限のモック使用
3. **並列実行**: 可能な限りt.Parallel()使用
4. **ヘルパー共有**: 共通テストユーティリティの活用

## 9. 結論

サービス固有のテスト戦略追加により、以下の効果が期待されます：

1. **品質向上**: 各サービスの特性に応じた包括的テスト
2. **開発速度**: 明確なテスト指針による効率的な実装
3. **保守性**: 具体例による新規開発者のオンボーディング改善
4. **信頼性**: プロダクション環境での問題の早期発見

新規開発プロジェクトとして、今このタイミングでテスト戦略を確立することで、技術的負債を最小限に抑え、高品質なシステムを構築できます。

---

*本計画書は随時更新され、実装の進捗に応じて調整されます。*