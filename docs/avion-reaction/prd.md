# PRD: avion-reaction

## 概要

Avionにおける投稿（Drop）に対する絵文字リアクション機能を提供するマイクロサービスを実装する。ユーザーがDropに対して絵文字で反応し、そのリアクションを集計・表示する機能を持つ。

## 背景

MisskeyライクなSNS体験の中核的な要素として、投稿に対して多様な絵文字で気軽に反応できる機能は、コミュニケーションを豊かにし、ユーザーエンゲージメントを高める上で重要である。リアクションの追加、削除、および特定のDropに対するリアクションの集計・取得を責務とするマイクロサービスを設けることで、この機能を他のサービスから分離し、スケーラビリティと独立性を確保する。

## Scientific Merits

*   **ユーザーエンゲージメント向上:** 「いいね」よりも表現豊かなリアクション機能は、ユーザー間のインタラクションを促進し、プラットフォームへの滞在時間や満足度を高める可能性がある。
*   **スケーラビリティ:** リアクションデータは投稿数やユーザー数に応じて増加するため、独立したサービスとしてスケールさせることが有効。特にリアクションの集計処理は負荷がかかる可能性がある。
*   **関心の分離:** リアクションという特定の機能に関するロジックを集約することで、`avion-post` や `avion-timeline` などのサービスは本来の責務に集中できる。

定量的な効果測定は難しいが、Misskeyなどの先行事例から、絵文字リアクション機能がユーザーに好まれ、活発なコミュニティ形成に寄与することは期待できる。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)

## 製品原則

*   **表現豊かな反応:** ユーザーが多様な絵文字を使ってDropへの感情や反応を表現できること。
*   **簡単な操作:** 直感的で簡単な操作でリアクションを追加・削除できること。
*   **明確な集計:** どのDropにどの絵文字がいくつ付いているかを分かりやすく表示すること。

## やること/やらないこと

### やること

*   特定のDropに対する絵文字リアクションの追加
*   自身が行ったリアクションの削除 (取り消し)
*   特定のDropに付与されたリアクションの一覧と、各絵文字のカウント数の取得
*   特定のユーザーが特定のDropに対してリアクションしたかどうかの判定
*   (将来的に) カスタム絵文字のサポート
*   (将来的に) ActivityPub連携 (`Like` アクティビティの送受信、またはカスタム拡張)

### やらないこと

*   **絵文字自体の管理:** 使用可能な絵文字のリストやカスタム絵文字の登録・管理機能は、初期段階ではこのサービスに含めない (別途設定ファイルや別サービスで管理する可能性)。
*   **リアクションに基づく通知:** リアクションが付いたことによる通知は `avion-notification` が担当する。
*   **リアクションに基づくタイムラインソート:** リアクション数を考慮したタイムラインの並び替えは `avion-timeline` の将来的な拡張。
*   **リアクションデータの永続的な履歴保存 (詳細レベル):** 誰がいつどのリアクションをしたかの完全なログは、パフォーマンスとストレージの観点から、必ずしも永続化しない可能性がある (集計結果は保持)。

## 対象ユーザ

*   Avion エンドユーザー (API Gateway経由)
*   Avion の他のマイクロサービス (`avion-notification`, `avion-activitypub`)
*   Avion 開発者・運用者

## ユースケース

### Dropへのリアクション追加

1.  ユーザーはDropの下部などに表示されるリアクションボタン (または絵文字ピッカー) を操作し、特定の絵文字を選択する。
2.  フロントエンドは `avion-gateway` 経由で `avion-reaction` にリアクション追加リクエスト (Drop ID, 絵文字コード, 認証JWT) を送信する。
3.  `avion-reaction` は、ユーザーが同じ絵文字で既にリアクションしていないか確認する。
4.  まだリアクションしていなければ、データベースにリアクション情報 (Drop ID, User ID, 絵文字コード, 作成日時) を記録する。
5.  リアクション成功のレスポンスを返す。
6.  (非同期) 必要に応じて `avion-notification` や `avion-activitypub` にリアクションイベントを通知する。

(UIモック: Drop下のリアクションボタン/ピッカー)

### リアクションの削除 (取り消し)

1.  ユーザーは自身が追加したリアクション (ハイライト表示されている等) を再度クリック/タップする。
2.  フロントエンドは `avion-gateway` 経由で `avion-reaction` にリアクション削除リクエスト (Drop ID, 絵文字コード, 認証JWT) を送信する。
3.  `avion-reaction` は、データベースから該当するリアクション情報を削除する。
4.  削除成功のレスポンスを返す。
5.  (非同期) 必要に応じて `avion-activitypub` に `Undo(Like)` イベントを通知する。

(UIモック: 自身が付けたリアクションの表示)

### Dropのリアクション一覧表示

1.  フロントエンドがDropを表示する際、そのDropに付いているリアクション情報を取得する必要がある。
2.  フロントエンドは `avion-gateway` 経由で `avion-reaction` にリアクション取得リクエスト (Drop ID) を送信する。
3.  `avion-reaction` はデータベースから指定されたDrop IDに関連するリアクションを集計し、絵文字ごとのカウント数と、(必要であれば) リクエストしたユーザーが各絵文字にリアクションしているかのフラグを返す。
4.  フロントエンドは受け取った情報をもとに、Dropの下部などにリアクションの絵文字とカウント数を表示する。

(UIモック: Drop下に表示されるリアクション集計)

## 機能要求

*   **リアクション対象:** Dropに対してリアクションできること。
*   **絵文字:** Unicode絵文字をサポートすること。絵文字コード (例: `:smile:`, Unicode文字自体) で識別できること。
*   **一意性:** 1ユーザーは1つのDropに対して同じ絵文字で複数回リアクションできないこと。
*   **集計:** Dropごとに、どの絵文字が何回リアクションされたかを効率的に集計できること。
*   **API:** リアクションの追加、削除、特定Dropのリアクション集計取得のためのRESTful APIを提供すること。認証が必要なエンドポイントはJWTで保護すること。

## 技術的要求

### レイテンシ

*   リアクション追加/削除: 平均 150ms 以下
*   リアクション集計取得: 平均 100ms 以下 (キャッシュ活用時)

### 可用性

*   リアクションの追加・削除・表示は比較的高可用性が求められる。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。

### スケーラビリティ

*   リアクション数はDrop数×ユーザー数に比例して増加する可能性があるため、データベースの書き込み・読み取り性能が重要。
*   リアクション集計クエリがボトルネックにならないように、適切なインデックス設計やキャッシュ戦略が必要。Redisによるカウントキャッシュなどが有効。

### データ整合性

*   リアクションのカウント数と実際のリアクションレコードの整合性を保つこと。
*   削除されたDropやユーザーに関連するリアクションデータを適切に処理すること (例: カスケード削除、定期的なクリーンアップ)。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。集計キャッシュはRedisで管理する。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。API Gatewayからトレースコンテキストを受け取り、イベント発行時にもコンテキストを伝播すること。

## 決まっていないこと

*   カスタム絵文字のサポート範囲と実装方法。
*   ActivityPubでのリアクション表現方法 (`Like` を使うか、カスタムアクティビティか)。
*   リアクションデータの具体的なDBスキーマ設計 (集計効率を考慮)。
*   キャッシュ戦略の詳細 (どの情報をどのキーでキャッシュするか)。
*   大量リアクションが付いた場合の集計パフォーマンス対策。
