# PRD: avion-media

## 概要

Avionにおける画像、動画などのメディアファイルのアップロード、保存、および配信機能を提供するマイクロサービスを実装する。

## 背景

テキストベースのSNSであっても、画像や動画を添付して投稿する機能はユーザー表現の幅を広げ、コミュニケーションを豊かにするために不可欠である。メディアファイルの効率的なアップロード処理、安全な保存、そして高速な配信を実現するためには、専用のマイクロサービスが必要となる。特に大容量ファイルの扱いや、多様なデバイス向けの最適化（サムネイル生成、形式変換など）は専門的な処理が求められる。

## Scientific Merits

*   **ユーザー体験の向上:** 画像や動画の添付により、よりリッチなコンテンツ投稿が可能になり、ユーザー満足度が向上する。
*   **パフォーマンス:** メディア配信にCDNなどを活用することで、表示速度を向上させることができる。アップロード/変換処理を非同期化することで、投稿時の待ち時間を短縮できる。
*   **スケーラビリティ:** メディアファイルのストレージ容量や配信トラフィックは大きく変動する可能性があるため、独立したサービスとしてオブジェクトストレージやCDNと連携し、スケールさせることが有効。
*   **関心の分離:** メディア処理という専門的なタスクを他のサービスから分離することで、各サービスの責務が明確になる。

メディア機能はストレージコストや配信コストが発生するものの、ユーザー体験への貢献度は非常に高く、現代的なSNSには必須の機能と言える。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)

## 製品原則

*   **簡単なアップロード:** ユーザーが直感的にメディアファイルを投稿に添付できること。
*   **安全な保存:** アップロードされたファイルが安全かつ確実に保存されること。
*   **高速な配信:** 添付されたメディアが様々なデバイスで高速に表示されること。

## やること/やらないこと

### やること

*   画像・動画ファイルのアップロードAPIの提供。
*   アップロードされたファイルのバリデーション (ファイル形式、サイズ制限)。
*   アップロードされたファイルのオブジェクトストレージ (S3互換) への保存。
*   保存されたファイルへの一意なID/URLの割り当て。
*   サムネイル画像の生成 (画像、動画)。
*   (将来的に) 動画の形式変換・ストリーミング配信対応。
*   (将来的に) メディアファイルの削除 (Drop削除との連携)。
*   メディアファイルへのアクセス制御 (例: 限定公開Dropに添付されたメディアへのアクセス制限)。
*   CDN連携による高速配信。
*   リモートメディアのキャッシュ: ActivityPub経由で受信したリモートメディアファイルを、設定に基づいてローカルのオブジェクトストレージにキャッシュする。

### やらないこと

*   **Dropとの関連付け管理:** どのDropにどのメディアが添付されているかの情報は `avion-post` が管理する。`avion-media` はメディア自体の管理に専念する。
*   **ユーザーインターフェース:** アップロードボタンやメディア表示コンポーネントは `avion-web` が担当する。
*   **オブジェクトストレージ自体の実装:** S3互換のオブジェクトストレージ (MinIO, Ceph, AWS S3など) を利用することを前提とする。
*   **CDN自体の実装:** CloudFront, Cloudflareなどの既存CDNサービスを利用することを前提とする。
*   **高度な画像・動画編集機能:** トリミング、フィルタ適用などの編集機能は提供しない。
*   **リモートメディアの永続保証:** キャッシュしたリモートメディアは永続性を保証せず、オリジンサーバーの状態やキャッシュポリシーに基づき削除される可能性がある。

## 対象ユーザ

*   Avion エンドユーザー (メディアアップロード時、API Gateway経由)
*   Avion フロントエンド (メディア表示時、直接 or CDN経由)
*   Avion の他のマイクロサービス (`avion-post`, `avion-activitypub` など、メディアID/URL連携)
*   Avion 開発者・運用者

## ユースケース

### メディアファイルのアップロード

1.  ユーザーが投稿フォームで画像/動画ファイルを選択する。
2.  フロントエンドは `avion-gateway` 経由で `avion-media` にアップロードリクエストを送信する。リクエストにはファイルデータと認証JWTが含まれる。
3.  `avion-media` はファイル形式、サイズを検証する。
4.  検証が通れば、ファイルを一時領域に保存し、非同期処理（サムネイル生成、オブジェクトストレージへのアップロード）をキューに入れる。
5.  すぐに仮のメディアID (または処理中を示す情報) をフロントエンドに返す。
6.  フロントエンドは仮IDを使って投稿を作成 (`avion-post` へリクエスト)。
7.  (非同期バックグラウンド) `avion-media` のワーカーがファイルをオブジェクトストレージにアップロードし、サムネイルを生成してそれもアップロードする。
8.  処理完了後、永続的なメディアIDとURL、サムネイルURLなどをデータベースに記録し、必要であれば `avion-post` に通知してDropレコード内のメディア情報を更新する。

(UIモック: 投稿フォームのファイル選択ボタン、アップロード中のプログレス表示)

### 添付メディアの表示

1.  フロントエンドがDropを表示する際、添付メディアのURL (CDN経由が望ましい) を `avion-post` から取得する。
2.  フロントエンドは取得したURLを使って画像や動画を表示する (`<img>` タグや `<video>` タグ)。
3.  リクエストはCDNを経由し、キャッシュされていればCDNから、なければオリジン (オブジェクトストレージ or `avion-media` の配信エンドポイント) からファイルが配信される。
4.  (アクセス制御が必要な場合) `avion-media` が署名付きURLなどを生成し、それを使ってアクセスするフローも考えられる。

(UIモック: タイムラインやDrop詳細画面での画像・動画表示)

### メディアファイルの削除

1.  ユーザーがメディアを添付したDropを削除する (`avion-post` が処理)。
2.  `avion-post` はDrop削除イベントを発行し、そのDropに添付されていたメディアIDリストを含む。
3.  `avion-media` はイベントを受信する。
4.  該当するメディアIDについて、参照カウントを確認するか、あるいは一定期間後にオブジェクトストレージからファイルを削除する非同期ジョブをスケジュールする (即時削除はリスクがあるため慎重に検討)。

### リモートメディアのキャッシュ

1.  `avion-activitypub` サービスがリモートDropを受信し、添付メディアのURLを発見する。
2.  `avion-activitypub` は設定に基づき、そのメディアURLを `avion-media` にキャッシュ依頼する。
3.  `avion-media` は依頼を受け、非同期でリモートURLからメディアファイルを取得する。
4.  取得したファイルをローカルのオブジェクトストレージに保存する。
5.  キャッシュされたメディアへのローカルURL (CDN経由) を生成し、`avion-activitypub` (または関連するデータストア) に通知/保存する。
6.  ローカルユーザーが該当のリモートDropを表示する際、フロントエンドはキャッシュされたローカルURLを使用する。

## 機能要求

*   **対応フォーマット:** 一般的な画像形式 (JPEG, PNG, GIF, WebP)、動画形式 (MP4, MOV) をサポートすること。
*   **サイズ制限:** アップロード可能なファイルサイズに上限を設けること (例: 画像 10MB, 動画 100MB)。
*   **ストレージ:** S3互換のオブジェクトストレージにファイルを保存すること。
*   **サムネイル:** アップロードされた画像や動画から、表示に適したサイズのサムネイルを自動生成すること。
*   **配信:** 保存されたメディアファイルおよびサムネイルをHTTP(S)経由で配信できること。CDN連携を考慮した設計であること。
*   **API:** メディアアップロード用のAPIを提供すること。認証が必要。リモートメディアキャッシュ依頼用の内部APIも提供する。
*   **非同期処理:** 時間のかかる処理 (ファイル変換、オブジェクトストレージへの転送、リモートメディア取得) は非同期で行うこと。

## 技術的要求

### レイテンシ

*   アップロードAPIの初期応答 (仮ID払い出し): 平均 500ms 以下
*   メディア配信 (CDNキャッシュヒット時): 数十msオーダー
*   メディア配信 (CDNキャッシュミス時): オブジェクトストレージの性能に依存するが、数百msオーダーを目指す。
*   リモートメディアキャッシュ処理: 非同期。数分程度の遅延は許容。

### 可用性

*   メディア配信は高可用性が求められる。オブジェクトストレージとCDNの可用性に依存する部分が大きい。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。
*   アップロードAPI、キャッシュ処理も安定稼働が必要。

### スケーラビリティ

*   アップロード処理、変換処理、キャッシュ処理を行うワーカーをスケールアウト可能にすること。
*   オブジェクトストレージ、CDNがスケール可能であることを前提とする。
*   大量のファイル保存、大量の配信リクエストに対応できること。

### セキュリティ

*   **アクセス制御:** 非公開メディアへの不正アクセスを防ぐ仕組み (署名付きURLなど) を検討すること。
*   **入力検証:** アップロードされるファイルの内容を検証し、悪意のあるファイル (例: ポリグロットファイル) による攻撃を防ぐこと。リモートメディア取得時も同様の注意が必要。
*   **ストレージセキュリティ:** オブジェクトストレージのバケットポリシーやアクセスキーを適切に管理すること。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。処理中の状態はキューやRedisで管理する。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。API Gatewayやイベント経由でトレースコンテキストを受け取り、伝播すること。
*   **外部連携:** S3互換APIおよびCDNとの連携を前提とする。

## 決まっていないこと

*   使用するオブジェクトストレージの具体的な選定 (MinIO, AWS S3など)。
*   使用するCDNの具体的な選定。
*   動画処理ライブラリ/ツールの選定 (ffmpegなど)。
*   非同期処理キューシステムの選定。
*   メディア削除の具体的な戦略 (参照カウント、遅延削除など)。
*   リモートメディアキャッシュのポリシー詳細 (キャッシュ期間、サイズ上限、対象ドメイン制限など)。
*   アクセス制御の実装方式 (署名付きURLなど)。
*   サポートする具体的なファイル形式とサイズ制限の値。
