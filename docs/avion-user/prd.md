# PRD: avion-user

## 概要

Avionにおけるユーザーアカウント管理およびフォロー関係の管理機能を提供するマイクロサービスを実装する。

## 背景

SNSアプリケーションの中核機能として、ユーザーアカウント（人間およびBot）の登録、認証、プロフィール情報の管理、およびユーザー間のフォロー関係を管理する機能が必要となる。認証機能 (`avion-user`) と認可機能 (`avion-authz`) を分離しつつ、ユーザー情報の管理を一元化することで、スケーラビリティとメンテナンス性を向上させる。

## Scientific Merits

*   **スケーラビリティ:** ユーザー数や認証リクエストが増加した場合、`avion-user` サービスを独立してスケールアウトさせることが容易になる。
*   **関心の分離:** ユーザー管理という重要な責務を他のサービスから分離することで、コードベースが整理され、開発とテストが容易になる。
*   **セキュリティ:** 認証や個人情報に関わる処理を一つのサービスに集約することで、セキュリティ対策を集中させ、リスクを管理しやすくなる。

定量的なメリットを示すのは難しいが、ユーザー管理は多くの機能の基盤となるため、独立したサービスとして堅牢に実装することの価値は高い。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)

## 製品原則

*   **安全なアカウント管理:** ユーザー情報を安全に保護し、確実な認証を提供する。
*   **スムーズなユーザー体験:** 簡単な登録、ログイン、プロフィール管理を実現する。
*   **明確なフォロー関係:** ユーザー間のフォロー/フォロワー関係を正確に管理する。

## やること/やらないこと

### やること

*   ユーザーアカウントの新規登録 (ユーザー名、メールアドレス、パスワード)
*   ユーザーアカウント (人間) の新規登録 (ユーザー名、メールアドレス、パスワード)
*   ユーザー認証 (ログイン): パスワード、Passkey、TOTP
*   セッション管理 (JWT発行)
*   Passkeyの登録・管理
*   TOTPの登録・管理・検証
*   ユーザープロフィールの取得・更新 (表示名、自己紹介、アイコン/ヘッダー画像URLなど)
*   他のユーザーのフォロー/アンフォロー
*   フォローリスト/フォロワーリストの取得
*   ユーザー情報の取得 (公開可能な範囲で)
*   Botユーザーアカウントの登録・管理 (人間ユーザーに紐づく。APIキー/シークレットの発行・失効は `avion-authz` と連携する可能性あり)
*   フォローリスト/フォロワーリストの取得
*   ユーザー情報の取得 (公開可能な範囲で)

### やらないこと

*   **複雑な認証フロー (初期):** OAuth連携などは初期リリースでは実装しない。
*   **ユーザーブロック機能 (初期):** 初期リリースでは実装しない (将来的に検討)。
*   **ユーザー検索機能:** 検索は `avion-search` サービスが担当する。
*   **管理者によるユーザー管理機能 (初期):** 初期リリースでは実装しない。
*   **認可 (Authorization):** 認可判定自体は `avion-authz` が担当する。

## 対象ユーザ

*   Avion エンドユーザー
*   Avion の他のマイクロサービス (API Gateway経由)
*   Avion 開発者・運用者

## ユースケース

### ユーザー新規登録

1.  ユーザーは登録フォームにユーザー名、メールアドレス、パスワードを入力し、送信する。
2.  `avion-gateway` 経由で `avion-user` にリクエストが送られる。
3.  `avion-user` はユーザー名とメールアドレスの重複を確認する。
4.  重複がなければ、パスワードをハッシュ化してデータベースにユーザー情報を保存する。
5.  登録成功のレスポンスを返す。

(UIモック: 登録フォーム画面)

### ユーザーログイン

1.  ユーザーはログインフォームにユーザー名(またはメールアドレス)とパスワードを入力し、送信する。
2.  `avion-gateway` 経由で `avion-user` にリクエストが送られる。
3.  `avion-user` はユーザー情報を検索し、提供されたパスワードと保存されているハッシュ化パスワードを比較する。
4.  認証が成功した場合、JWT (JSON Web Token) を生成し、レスポンスとして返す。
5.  `avion-gateway` はこのJWTを後続のリクエストで使用する。

(UIモック: ログインフォーム画面)

### Passkey登録

1.  ユーザーは設定画面からPasskeyの登録を開始する。
2.  フロントエンドは `avion-gateway` 経由で `avion-user` にPasskey登録チャレンジ要求を送信する。
3.  `avion-user` はWebAuthnの登録チャレンジを生成し、フロントエンドに返す。
4.  フロントエンドはブラウザ/OSのWebAuthn APIを呼び出し、ユーザーに認証器（デバイス、セキュリティキーなど）での操作を促す。
5.  ユーザーが操作を完了すると、認証器からの応答 (クレデンシャル情報) がフロントエンドに返る。
6.  フロントエンドはその応答を `avion-gateway` 経由で `avion-user` に送信する。
7.  `avion-user` はチャレンジと応答を検証し、問題なければ公開鍵などのクレデンシャル情報をユーザーに関連付けてデータベースに保存する。
8.  登録成功のレスポンスを返す。

(UIモック: 設定画面のPasskey登録フロー)

### Passkey認証 (ログイン)

1.  ユーザーはログイン画面でユーザー名を入力し、Passkeyでのログインを選択する。
2.  フロントエンドは `avion-gateway` 経由で `avion-user` にPasskey認証チャレンジ要求を送信する (ユーザー名を含む)。
3.  `avion-user` は該当ユーザーに登録されているPasskeyクレデンシャル情報に基づき、WebAuthnの認証チャレンジを生成し、フロントエンドに返す。
4.  フロントエンドはWebAuthn APIを呼び出し、ユーザーに認証器での操作を促す。
5.  ユーザーが操作を完了すると、認証器からの応答 (アサーション) がフロントエンドに返る。
6.  フロントエンドはその応答を `avion-gateway` 経由で `avion-user` に送信する。
7.  `avion-user` はチャレンジと応答、保存されている公開鍵を使って署名を検証する。
8.  検証が成功すれば、JWTを生成して返し、ログイン成功とする。

(UIモック: ログイン画面のPasskey認証フロー)

### TOTP登録

1.  ユーザーは設定画面からTOTPの登録を開始する。
2.  フロントエンドは `avion-gateway` 経由で `avion-user` にTOTP登録要求を送信する。
3.  `avion-user` はTOTP用の秘密鍵を生成し、QRコード表示用のデータ (otpauth:// URI) と秘密鍵をデータベースに一時保存 (またはユーザーに関連付けて保存) し、QRコードデータをフロントエンドに返す。
4.  フロントエンドはQRコードを表示する。ユーザーは認証アプリ (Google Authenticatorなど) でQRコードをスキャンする。
5.  ユーザーは認証アプリに表示された6桁のコードを入力するフォームにコードを入力し、送信する。
6.  フロントエンドはそのコードを `avion-gateway` 経由で `avion-user` に送信する。
7.  `avion-user` は保存している秘密鍵と送信されたコードを検証する。
8.  検証が成功すれば、TOTP登録を有効化し、成功レスポンスを返す。

(UIモック: 設定画面のTOTP登録フロー、QRコード表示、確認コード入力)

### TOTP認証 (ログイン時)

1.  ユーザーがパスワード認証 (またはPasskey認証) に成功した後、TOTPが有効になっている場合、TOTPコード入力画面が表示される。
2.  ユーザーは認証アプリに表示された6桁のコードを入力し、送信する。
3.  フロントエンドはそのコードを `avion-gateway` 経由で `avion-user` に送信する。
4.  `avion-user` はユーザーに登録されているTOTP秘密鍵と送信されたコードを検証する。
5.  検証が成功すれば、ログインを完了させ、JWTを生成して返す。

(UIモック: ログインフロー中のTOTPコード入力画面)

### Botユーザー登録 (UIフローは avion-web PRD参照)

1.  人間ユーザーからのリクエストを受け、Botユーザー用のアカウント情報を内部的に生成・保存する。
2.  Botに付与する権限スコープ情報を `avion-authz` に登録依頼する。
3.  `avion-authz` (または本サービス) が生成したAPIキー/シークレットを受け取り、(初回のみ) フロントエンドに返す。

### Botユーザー情報管理

*   人間ユーザーが自身が作成したBotユーザーの一覧表示、APIキーの再生成、失効、削除などを行うためのAPIを提供する。(`avion-authz` と連携)

### プロフィール表示

1.  ユーザーは他のユーザーのプロフィールページ、または自身のプロフィール設定ページを開く。
2.  `avion-gateway` 経由で `avion-user` に該当ユーザーのプロフィール情報取得リクエストが送られる。
3.  `avion-user` はデータベースからユーザー情報を取得し、公開可能な情報 (または自身の全情報) を返す。
4.  フロントエンドは受け取った情報をもとにプロフィールを表示する。

(UIモック: プロフィール画面)

### プロフィール編集

1.  ユーザーは自身のプロフィール設定ページで表示名や自己紹介などを編集し、保存する。
2.  `avion-gateway` 経由で `avion-user` にプロフィール更新リクエストが送られる (認証JWTが必要)。
3.  `avion-user` はリクエスト元のユーザーIDを確認し、データベースの情報を更新する。
4.  更新成功のレスポンスを返す。

(UIモック: プロフィール編集画面)

### ユーザーフォロー

1.  ユーザーAはユーザーBのプロフィールページなどで「フォロー」ボタンを押す。
2.  `avion-gateway` 経由で `avion-user` にフォローリクエストが送られる (認証JWTが必要)。
3.  `avion-user` はユーザーAがユーザーBをフォローする情報をデータベースに記録する。
4.  フォロー成功のレスポンスを返す。

(UIモック: プロフィール画面上のフォローボタン)

### フォロー解除 (アンフォロー)

1.  ユーザーAはユーザーBのプロフィールページなどで「フォロー解除」ボタンを押す。
2.  `avion-gateway` 経由で `avion-user` にアンフォローリクエストが送られる (認証JWTが必要)。
3.  `avion-user` はユーザーAがユーザーBをフォローしている情報をデータベースから削除する。
4.  アンフォロー成功のレスポンスを返す。

(UIモック: プロフィール画面上のフォロー解除ボタン)

## 機能要求

*   **ユーザー名:** 一意であること。使用可能な文字種や長さに制限を設けること。
*   **メールアドレス:** 一意であること。形式が正しいか検証すること。
*   **パスワード:** 安全なハッシュ化アルゴリズム (例: bcrypt, Argon2) を使用して保存すること。最低限の強度要件 (長さ、文字種など) を設けること。
*   **Passkey (WebAuthn):** FIDO2/WebAuthn標準に準拠した登録・認証フローを実装すること。クレデンシャル情報を安全に保存すること。
*   **TOTP:** TOTP標準 (RFC 6238) に準拠したコード生成・検証ロジックを実装すること。秘密鍵を安全に保存すること。
*   **フォロー関係:** フォロー/フォロワーの関係性をデータベースで正確に管理すること。自分自身をフォローできないようにすること。
*   **API:** ユーザー情報、認証 (パスワード、Passkey, TOTP)、フォロー操作、Botユーザー管理のためのRESTful API (またはgRPC) を提供すること。認証が必要なエンドポイントはJWTで保護すること。

## 技術的要求

### レイテンシ

*   ログイン処理: 平均 200ms 以下
*   プロフィール取得: 平均 100ms 以下
*   フォロー/アンフォロー: 平均 150ms 以下

### 可用性

*   ユーザー認証やプロフィール取得は高可用性が求められる。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。

### セキュリティ

*   **パスワード:** 平文で保存しない。適切なハッシュ化とソルトを使用する。
*   **個人情報:** メールアドレスなどの個人情報は適切に保護する。
*   **認証:** 安全なJWTの実装 (適切なアルゴリズム、有効期限、リフレッシュトークンの検討)。
*   **入力検証:** SQLインジェクションやクロスサイトスクリプティング (XSS) に繋がるような入力は適切にバリデーション/サニタイズする。
*   **レートリミット:** ログイン試行回数などに制限を設け、ブルートフォース攻撃を防ぐ (API Gateway側で実装する可能性も)。Passkey/TOTPのチャレンジ要求にもレートリミットを設ける。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。セッション情報はJWTやRedisなどで管理する。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。API Gatewayからトレースコンテキストを受け取り、伝播すること。

## 決まっていないこと

*   パスワードリセットの実装方法 (メール送信など)
*   アイコン/ヘッダー画像の具体的な保存・管理方法 (`avion-media` との連携)
*   JWTのリフレッシュトークンの導入要否と実装方法
*   Botユーザー管理の詳細なフローと `avion-authz` との具体的な連携方法 (APIキー生成・保存場所など)。
*   ユーザーブロック機能の仕様詳細 (将来的に実装する場合)
