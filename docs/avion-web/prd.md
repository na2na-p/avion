# PRD: avion-web

## 概要

Avionのユーザーインターフェースを提供するWebフロントエンドアプリケーションを実装する。ReactとTypeScriptを使用し、Web BFF (`avion-bff-web`) を介してバックエンド機能を利用する。Progressive Web App (PWA) として実装し、リアルタイム更新にはServer-Sent Events (SSE)、プッシュ通知にはWeb Pushを利用する。

## 背景

ユーザーがAvionの各種機能（タイムラインの閲覧、Dropの作成・閲覧、ユーザーのフォロー、リアクション、通知の確認など）を直感的に利用できるようにするためには、使いやすいWebインターフェースが必要である。Web BFF (`avion-bff-web`) がバックエンドマイクロサービス群との通信を抽象化し、フロントエンドはBFFが提供するAPIを利用してUIの構築とユーザーインタラクションに集中する。モダンなWeb技術 (React, TypeScript, PWA, SSE, Web Push) を採用することで、開発効率とメンテナンス性、そしてインタラクティブでネイティブアプリに近いユーザー体験を実現する。

## Scientific Merits

*   **ユーザー体験の向上:** バックエンド機能を使いやすく、魅力的なインターフェースで提供することで、ユーザー満足度とエンゲージメントを高める。PWA化によりインストール可能になり、SSE/Web Pushによりリアルタイム性が向上する。
*   **機能アクセスの提供:** マイクロサービス群が提供する機能をユーザーが実際に利用するための手段を提供する。
*   **開発効率:** ReactのコンポーネントベースアーキテクチャとTypeScriptの型システムにより、大規模なフロントエンドアプリケーションの開発とメンテナンスを効率化する。

フロントエンドはユーザーが直接触れる部分であり、その品質はサービス全体の評価に直結する。

## Design Doc

後で書く (UI/UXデザインに関するドキュメントも別途必要になる可能性が高い)

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)
*   (UIデザインモックなどは別途作成・参照)

## 製品原則

*   **直感的で使いやすい:** ユーザーが迷うことなく、主要な機能を簡単に見つけて操作できること。
*   **高速なレスポンス:** 画面遷移やデータ読み込みがスムーズで、ストレスなく利用できること。
*   **アクセシビリティ:** 様々なユーザーが利用できるよう、アクセシビリティ標準 (WCAGなど) への配慮を行うこと。
*   **一貫性のあるデザイン:** アプリケーション全体で統一感のあるデザイン言語と操作性を提供する。
*   **リアルタイム性:** 新しい情報 (Drop, 通知) が可能な限りリアルタイムで反映されること。
*   **インストール可能:** PWAとしてデバイスにインストールして利用できること。

## やること/やらないこと

### やること

*   **主要画面の実装:**
    *   ログイン/新規登録画面
    *   タイムライン表示画面 (ホーム, ローカル, グローバルタブ切り替え、無限スクロール/ページネーション、SSEによるリアルタイム更新)
    *   Drop作成フォーム (テキスト入力、メディア添付UI、公開範囲選択)
    *   Drop詳細表示画面 (Drop本体、リアクション表示/操作、返信表示など)
    *   ユーザープロフィール画面 (ユーザー情報、Drop一覧、フォロー/フォロワー表示、フォローボタン)
    *   プロフィール編集画面
*   通知一覧画面 (SSEによる更新通知)
*   検索画面 (Drop検索タブ、ユーザータブ)
*   基本的な設定画面 (パスワード変更、Passkey管理、TOTP管理、通知設定、Bot管理)
*   **API連携:** `avion-bff-web` が提供するAPIと通信し、データを取得・表示・更新する。
*   **状態管理:** アプリケーションの状態 (ユーザー認証情報、表示データ、UI状態など) を管理する。
*   **ルーティング:** URLに基づいて表示する画面を制御する。
*   **レスポンシブデザイン:** デスクトップ、タブレット、スマートフォンの各画面サイズに対応する。
*   **基本的なアクセシビリティ対応:** セマンティックHTML、キーボード操作、適切なコントラストなどを考慮する。
*   **PWA対応:** Web App Manifestを提供し、基本的なService Workerを実装してインストール可能にする。オフライン対応は初期では限定的。
*   **SSE接続:** タイムラインや通知のリアルタイム更新のためにServer-Sent Events (SSE) エンドポイントに接続し、イベントを処理する。
*   **Web Push購読/受信:** ユーザーに許可を求め、Web Push通知のためのサブスクリプションを行い、エンドポイント情報を `avion-bff-web` 経由でバックエンド (`avion-notification`) に送信する。Service Workerでプッシュイベントを受信し、通知を表示する。
*   **Passkey/TOTP UI:** PasskeyおよびTOTPの登録・認証フローに対応するUIを提供する。

### やらないこと

*   **ネイティブモバイルアプリ:** このPRDはWebフロントエンドを対象とする。ネイティブアプリは別途検討。
*   **高度なオフライン機能 (初期):** Service Workerによる基本的なキャッシュは行うが、完全なオフラインでの投稿作成などは初期では実装しない。
*   **高度な管理機能:** 管理者向けのダッシュボードなどは対象外。
*   **テーマカスタマイズ機能 (初期):** ダークモード以外の複雑なテーマ変更機能は初期では実装しない。
*   **WebSocket:** SSEで十分なため、現時点では実装しない。

## 対象ユーザ

*   Avion エンドユーザー

## ユースケース

(各ユースケースは、対応するバックエンドサービスのPRDに記載されたAPIコールと連携する形で記述される。ここでは主要な画面遷移と操作の概要を記す。)

### ログイン

1.  ユーザーはログイン画面で認証情報を入力し、ログインボタンを押す。
2.  `avion-bff-web` のログインAPIにリクエストを送信する。
3.  成功すればBFFからJWTを受け取りローカルストレージ等に保存。ホームタイムライン画面に遷移する。失敗すればエラーメッセージを表示。

(UIモック: ログイン画面)

### ホームタイムライン閲覧とDrop作成

1.  ログイン後、`avion-bff-web` からホームタイムラインデータを取得し、表示する。
2.  画面上部の投稿フォームにテキストを入力し、「Drop」ボタンを押す。
3.  入力内容を `avion-bff-web` のDrop作成APIに送信する。
4.  成功レスポンスを受け取ったら、タイムライン表示を更新する ( optimistic update または再取得)。

(UIモック: ホームタイムライン画面、投稿フォーム)

### 他ユーザーのプロフィール表示とフォロー

1.  タイムライン上のユーザーアイコンや名前をクリックする。
2.  `avion-bff-web` から該当ユーザーのプロフィールデータを取得し、表示する。
3.  「フォロー」ボタンが表示されていれば、それをクリックする。
4.  `avion-bff-web` のフォローAPIにリクエストを送信する。
5.  成功レスポンスを受け取ったら、ボタンの表示を「フォロー中」などに変える。

(UIモック: プロフィール画面)

### Dropへのリアクション

1.  タイムラインやDrop詳細画面で、Dropの下部に表示されているリアクションボタン (絵文字ピッカー) を操作する。
2.  特定の絵文字を選択すると、`avion-bff-web` のリアクションAPIにリクエストを送信する。
3.  成功レスポンスを受け取ったら、リアクション表示を更新する。

(UIモック: Drop下のリアクション表示エリア)

### 通知の確認

1.  ヘッダーなどの通知アイコン (未読件数バッジ付き) をクリックする。
2.  `avion-bff-web` から通知リストデータを取得し、表示する。
3.  画面を開いたタイミング、または特定の操作で `avion-bff-web` の通知既読化APIを呼び出す。

(UIモック: 通知一覧画面)

### PWAインストール

1.  ユーザーがAvion Webを対応ブラウザで開く。
2.  ブラウザがWeb App Manifestを認識し、インストールプロンプトを表示する (ブラウザ依存)。
3.  ユーザーがインストールを選択すると、PWAとしてデバイスにインストールされる。

### SSEによるタイムライン更新

1.  ユーザーがホームタイムライン画面を開く。
2.  フロントエンドは `avion-bff-web` (またはバックエンド) のSSEエンドポイントに接続する。 (接続先はBFFの設計による)
3.  SSE経由でタイムライン更新イベントを受信する。
4.  イベント内容に基づき、UI上のタイムライン表示を更新する。

### Web Push購読

1.  ユーザーがログイン後、(初回または設定画面で) プッシュ通知の許可を求めるプロンプトが表示される。
2.  ユーザーが許可すると、フロントエンドはブラウザのPush APIを使用してプッシュサービスにサブスクリプションを要求する。
3.  成功すると、サブスクリプション情報 (エンドポイントURLなど) が得られる。
4.  フロントエンドはこのサブスクリプション情報を `avion-bff-web` のAPI経由でバックエンドに送信し、保存させる。

### Passkey登録UIフロー

1.  ユーザーは設定画面で「Passkeyを追加」ボタンを押す。
2.  フロントエンドは `avion-bff-web` 経由で `avion-user` にチャレンジを要求。
3.  BFFからチャレンジを受け取り、ブラウザのWebAuthn API (`navigator.credentials.create()`) を呼び出す。
4.  ユーザーはOS/ブラウザの指示に従い認証器で操作。
5.  成功したら、クレデンシャル情報を `avion-bff-web` 経由で `avion-user` に送信して検証・保存させる。
6.  UIに登録完了メッセージを表示。

### Botユーザー管理 (設定画面内)

1.  ユーザーは設定画面の「Bot管理」セクションを開く。
2.  `avion-bff-web` から登録済みのBotユーザー一覧を取得し、表示する。
3.  「新しいBotを作成」ボタンを押すと、Bot名や権限スコープを選択するフォームが表示される。
4.  フォームを送信すると、`avion-bff-web` 経由でバックエンドに登録リクエストが送られる。
5.  成功すると、BFFから返されたAPIキーとシークレットが表示される (初回のみ)。ユーザーはこれを安全な場所にコピーする。
6.  一覧画面で、既存のBotを選択すると、APIキーの再生成や失効、削除などの操作を `avion-bff-web` のAPI経由で行える。

### TOTP登録UIフロー

1.  ユーザーは設定画面で「TOTPを有効化」ボタンを押す。
2.  フロントエンドは `avion-bff-web` 経iónで `avion-user` に登録を要求。
3.  BFFから返されたQRコードデータを表示。
4.  ユーザーが認証アプリでスキャンし、表示されたコードを入力するフォームを表示。
5.  ユーザーがコードを入力して送信。フロントエンドはコードを `avion-bff-web` 経由で `avion-user` に送信して検証させる。
6.  UIに登録完了メッセージを表示。

## 機能要求

*   **ブラウザ互換性:** 最新版の主要なモダンブラウザ (Chrome, Firefox, Safari, Edge) をサポートすること。
*   **レスポンシブ:** 様々な画面幅で適切にレイアウトが調整されること。
*   **状態管理:** アプリケーション全体の状態を効率的かつ予測可能に管理する仕組みを持つこと (例: Redux, Zustand, Jotai)。
*   **ルーティング:** ブラウザのHistory APIを利用したクライアントサイドルーティングを実装すること (例: React Router)。
*   **APIクライアント:** `avion-bff-web` との通信を行うための、型安全でエラーハンドリングが考慮されたAPIクライアント層を持つこと。
*   **UIコンポーネント:** 再利用可能で一貫性のあるUIコンポーネント (ボタン、入力フォーム、リスト、モーダルなど) を構築すること。UIライブラリ (MUI, Chakra UIなど) の利用も検討。
*   **PWA:** Web App Manifest (`manifest.json`) と基本的なService Worker (`service-worker.js`) を提供すること。
*   **SSEクライアント:** Server-Sent Eventsを受信し、適切に処理するクライアントロジックを実装すること (`EventSource` APIを利用)。
*   **Web Pushクライアント:** Push APIを使用してサブスクリプションを行い、Service Workerでプッシュイベントを処理するロジックを実装すること。

## 技術的要求

### パフォーマンス (Core Web Vitals)

*   **LCP (Largest Contentful Paint):** 2.5秒以内を目指す。
*   **FID (First Input Delay):** 100ミリ秒以内を目指す。
*   **CLS (Cumulative Layout Shift):** 0.1未満を目指す。
*   バンドルサイズの最適化、コード分割、画像の遅延読み込み、Service Workerによるキャッシュ戦略などを実施する。

### アクセシビリティ

*   **WCAG 2.1 Level AA を目標に対応を進める。
*   キーボードナビゲーション、スクリーンリーダー対応、適切なコントラスト比などを確保する。
*   PWAとしてのアクセシビリティも考慮する。

### セキュリティ

*   **XSS (Cross-Site Scripting) 対策:** ユーザー入力やAPIからのデータを表示する際に、適切なエスケープ処理を行う。Reactはデフォルトである程度保護するが、`dangerouslySetInnerHTML` の使用は避ける。
*   **CSRF (Cross-Site Request Forgery) 対策:** BFFと連携した対策 (例: SameSite Cookie属性、カスタムヘッダー) を検討する。
*   **依存関係の管理:** 使用するライブラリの脆弱性を定期的にチェックし、更新する。

## 決まっていないこと

*   **UI/UXデザインの詳細:** ワイヤーフレーム、モックアップ、デザインシステムの詳細。
*   **状態管理ライブラリの最終決定:** Redux, Zustand, Jotai, Recoilなどからの選定。
*   **UIコンポーネントライブラリの選定:** MUI, Chakra UI, Tailwind CSS + Headless UIなどからの選定、またはフルカスタム。
*   **APIクライアントの実装方法:** Fetch API, Axios, React Query, SWRなどの選定と組み合わせ (`avion-bff-web` のAPI仕様に依存)。
*   **テスト戦略:** ユニットテスト、結合テスト (BFFとの連携含む)、E2Eテストの具体的なツールとカバレッジ目標。
*   **ビルドツールと設定:** Vite, Webpackなどの設定詳細。
*   **Service Workerのキャッシュ戦略詳細:** どのリソースをどの程度キャッシュするか。
*   **SSE接続の扱い:** BFF経由か直接接続か。
*   **国際化 (i18n) / 地域化 (l10n) の対応方針:** 初期リリースで対応するか、将来的な拡張とするか。
