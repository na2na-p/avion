# PRD: avion-post

## 概要

Avionにおける投稿（Drop）の作成、取得、削除、編集（限定的）などの管理機能を提供するマイクロサービスを実装する。

## 背景

SNSアプリケーションの根幹となる機能として、ユーザーがテキストやメディアを含む投稿（Drop）を作成し、共有できる仕組みが必要となる。投稿データの管理、アクセス制御、関連操作（削除など）を責務とするマイクロサービスを設けることで、システムの他の部分から投稿関連のロジックを分離し、開発と運用を容易にする。

## Scientific Merits

*   **スケーラビリティ:** 投稿データ量やアクセス数の増加に対して、`avion-post` サービスを独立してスケールさせることが可能。
*   **関心の分離:** 投稿管理という明確な責務を持つことで、他のサービス（タイムライン生成、通知など）との依存関係を疎にし、開発効率とメンテナンス性を向上させる。
*   **データ整合性:** 投稿に関する操作を一元管理することで、データの整合性を保ちやすくなる。

投稿機能はSNSの利用頻度が最も高い部分の一つであり、独立したサービスとして性能と信頼性を確保することの価値は大きい。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)

## 製品原則

*   **自由な表現:** ユーザーがテキストや（将来的には）メディアを通じて自由に考えや情報を発信できること。
*   **確実な永続化:** 作成されたDropが確実に保存され、後から参照できること。
*   **適切なアクセス制御:** Dropの公開範囲設定に基づき、意図した範囲のユーザーのみが閲覧できるようにすること。

## やること/やらないこと

### やること

*   新しいDropの作成 (テキスト本文、公開範囲設定)
*   特定のDropの取得 (ID指定)
*   特定のユーザーが作成したDropのリスト取得 (ページネーション付き)
*   Dropの削除 (作成者本人のみ)
*   Dropの編集 (限定的な範囲で、例: 誤字脱字修正。編集履歴の扱いは別途検討)
*   Dropの公開範囲設定 (例: 公開、フォロワー限定、ダイレクトメッセージ - 初期は公開のみでも可)
*   (将来的に) 添付メディア情報の関連付け (メディア自体の管理は `avion-media` が担当)
*   (将来的に) 引用Drop、リポスト (Boost) のデータ構造サポート

### やらないこと

*   **タイムラインの生成:** ホームタイムラインやローカルタイムラインなどの生成は `avion-timeline` が担当する。
*   **リアクションの管理:** Dropへの絵文字リアクションは `avion-reaction` が担当する。
*   **通知の生成:** メンションやリポストに伴う通知は `avion-notification` が担当する。
*   **メディアファイルの保存・配信:** メディアファイルの実体は `avion-media` が管理する。`avion-post` は関連付け情報 (URLなど) を持つのみ。
*   **全文検索:** Dropの検索機能は `avion-search` が担当する。
*   **ハッシュタグの解析・インデックス作成:** 初期リリースでは実装しない (将来的に検討)。

## 対象ユーザ

*   Avion エンドユーザー (API Gateway経由)
*   Avion の他のマイクロサービス (Timeline, Notification, ActivityPubなど)
*   Avion 開発者・運用者

## ユースケース

### Dropの作成

1.  ユーザーは投稿フォームにテキストを入力し、公開範囲を選択して「Drop」ボタンを押す。
2.  `avion-gateway` 経由で `avion-post` にDrop作成リクエストが送られる (認証JWTが必要)。
3.  `avion-post` はリクエスト内容 (文字数制限など) を検証し、データベースに新しいDropレコードを作成する (作成者ID、本文、公開範囲、作成日時など)。
4.  作成されたDropのIDを含む成功レスポンスを返す。
5.  (非同期) 必要に応じて他のサービス (Timeline, ActivityPubなど) にDrop作成イベントを通知する (例: Redis Pub/Sub)。

(UIモック: 投稿フォーム)

### Dropの表示 (単一)

1.  ユーザーが特定のDropへのリンクをクリックする、または通知から遷移するなどして、単一のDropを表示しようとする。
2.  `avion-gateway` 経由で `avion-post` に特定のDrop IDを指定した取得リクエストが送られる。
3.  `avion-post` はデータベースから該当するDropの情報を取得する。
4.  取得したDropの公開範囲とリクエスト元のユーザーの権限 (本人か、フォロワーか、など) を照合し、アクセス可能か判断する。
5.  アクセス可能であればDrop情報を返し、不可であればエラー (例: 403 Forbidden or 404 Not Found) を返す。
6.  フロントエンドは受け取った情報をもとにDropを表示する。

(UIモック: Drop詳細表示)

### ユーザーのDrop一覧表示

1.  ユーザーが特定のユーザーのプロフィールページを開き、そのユーザーのDrop一覧を表示しようとする。
2.  `avion-gateway` 経由で `avion-post` に特定のユーザーIDとページネーション情報 (例: `limit`, `offset` or `since_id`) を指定したDrop取得リクエストが送られる。
3.  `avion-post` はデータベースから該当ユーザーが作成したDropを新しい順に取得する。
4.  取得した各Dropについて、公開範囲とリクエスト元のユーザーの権限を照合し、アクセス可能なDropのみをリストとして返す。
5.  フロントエンドは受け取ったリストをもとにDrop一覧を表示する。

(UIモック: プロフィールページのDropタブ)

### Dropの削除

1.  ユーザーは自身が作成したDropのメニューから「削除」を選択する。
2.  `avion-gateway` 経由で `avion-post` に特定のDrop IDを指定した削除リクエストが送られる (認証JWTが必要)。
3.  `avion-post` はDropの作成者IDとリクエスト元のユーザーIDが一致するか確認する。
4.  一致すれば、データベースから該当するDropレコードを削除 (論理削除または物理削除) する。
5.  削除成功のレスポンスを返す。
6.  (非同期) 必要に応じて他のサービスにDrop削除イベントを通知する。

(UIモック: Dropメニュー内の削除ボタン)

## 機能要求

*   **本文:** 最大文字数制限を設けること (例: 500文字)。Unicode文字を正しく扱えること。
*   **公開範囲:** Dropごとに公開範囲 (例: 公開, フォロワー限定) を設定できること。デフォルト値を設定できること。
*   **一意なID:** 各Dropにはシステム全体で一意なIDが付与されること (例: UUID, Snowflake ID)。
*   **タイムスタンプ:** 作成日時、最終更新日時を記録すること。
*   **API:** DropのCRUD操作のためのRESTful APIを提供すること。認証が必要なエンドポイントはJWTで保護すること。ページネーションをサポートすること。

## 技術的要求

### レイテンシ

*   Drop作成: 平均 200ms 以下
*   Drop取得 (単一): 平均 100ms 以下
*   ユーザーDrop一覧取得 (1ページあたり): 平均 300ms 以下

### 可用性

*   Dropの作成と取得は高可用性が求められる。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。

### セキュリティ

*   **入力検証:** Drop本文に含まれる可能性のある悪意のあるスクリプト等 (XSS) を適切にサニタイズ、または表示時にエスケープすること。
*   **アクセス制御:** Dropの公開範囲設定に基づき、不正なアクセスを防ぐこと。他人のDropを不正に編集・削除できないようにすること。
*   **削除処理:** 削除されたDropが意図せず参照されないようにすること (特にキャッシュなど)。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。API Gatewayからトレースコンテキストを受け取り、他のサービスへのイベント発行時にもコンテキストを伝播すること。

## 決まっていないこと

*   Drop編集機能の具体的な仕様 (編集可能な期間、編集履歴の表示有無など)
*   引用Drop、リポスト (Boost) のデータモデルとAPI仕様
*   ハッシュタグの抽出・管理方法 (将来的に実装する場合)
*   メンションの抽出・管理方法 (将来的に実装する場合)
*   Dropの物理削除 vs 論理削除の方針
