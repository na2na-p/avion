# PRD: avion-bff-web

## 概要

AvionのWebフロントエンド (`avion-web`) 専用のBackend for Frontend (BFF) サービスを実装する。`avion-web` が必要とするAPIを提供し、バックエンドのマイクロサービス群 (`avion-gateway` 経由) との通信を仲介・最適化する。

## 背景

Webフロントエンド (`avion-web`) が直接複数のマイクロサービスAPIを呼び出すのではなく、専用のBFF層を設けることで、フロントエンド開発を効率化し、バックエンドサービスとの結合度を下げる。BFFは `avion-web` の表示要件に特化し、複数のマイクロサービスからのデータ集約、必要な形式へのデータ変換、API呼び出しの最適化などを行う。これにより、フロントエンドはよりシンプルになり、表示ロジックに集中できる。

## Scientific Merits

*   **フロントエンド開発効率の向上:** フロントエンドはBFFが提供する最適化されたAPIのみを利用すればよくなり、バックエンドの詳細なAPI仕様やデータ構造を意識する必要が減る。データ取得・加工ロジックがBFFに移るため、フロントエンドのコードがシンプルになる。
*   **バックエンド独立性の向上:** バックエンドサービスは汎用的なAPIを提供することに集中でき、特定のフロントエンドの表示要件変更の影響を受けにくくなる。
*   **パフォーマンス最適化:** BFF層でAPI呼び出しを集約したり、不要なデータをフィルタリングしたりすることで、フロントエンドとバックエンド間の通信量を削減できる可能性がある。BFF内部で並列にバックエンドAPIを呼び出すなどの最適化も可能。
*   **API契約の安定化:** フロントエンドが依存するAPIがBFFに集約されるため、バックエンドサービスのAPI変更がフロントエンドに直接影響するのを緩和できる。

アーキテクチャにコンポーネントが増えるトレードオフはあるが、フロントエンドとバックエンドの分離を促進し、それぞれの開発効率と保守性を高める効果が期待できる。

## Design Doc

後で書く (言語選定: Go or TypeScript/Node.js などもここで決定)

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)
*   [avion-web PRD](./../avion-web/prd.md)

## 製品原則

*   **フロントエンド中心:** `avion-web` の要求に最適化されたAPIを提供する。
*   **効率的なデータ連携:** バックエンドサービスとの通信を効率的に行い、必要なデータを集約・加工する。
*   **薄い層:** BFF自体は複雑なビジネスロジックを持たず、主にデータの仲介・変換に専念する。状態は極力持たない。

## やること/やらないこと

### やること

*   **`avion-web` 向けAPIの提供:**
    *   タイムライン表示に必要なデータ (Drop詳細、ユーザー情報、リアクション情報を含む) を集約して返すAPI。
    *   プロフィール表示に必要なデータ (ユーザー情報、Dropリストなど) を集約して返すAPI。
    *   Drop作成、リアクション追加などの書き込み系操作をバックエンドサービスに中継するAPI。
    *   その他、`avion-web` が必要とする各種データ取得・操作API。
*   **バックエンドサービス連携:** `avion-gateway` を介して、`avion-user`, `avion-post`, `avion-timeline`, `avion-reaction` などのマイクロサービスAPIを呼び出す。
*   **データ集約と変換:** 複数のバックエンドAPIからのレスポンスを組み合わせ、`avion-web` が扱いやすい形式に加工する。
*   **認証情報の伝播:** `avion-web` から受け取った認証情報 (JWTなど) を `avion-gateway` に適切に渡す。
*   **SSEプロキシ/中継 (検討):** `avion-timeline` や `avion-notification` が提供するSSEストリームを、BFFが集約して `avion-web` に提供することも考えられる。

### やらないこと

*   **コアビジネスロジックの実装:** 投稿作成、ユーザー管理、タイムライン生成などのコアロジックは担当しない。これらは各専門マイクロサービスが担当する。
*   **データの永続化:** BFF自体は原則としてデータを永続化しない (キャッシュは利用する可能性あり)。
*   **認証・認可:** 認証情報の検証や認可チェックは `avion-gateway` (および `avion-user`, `avion-authz`) が担当する。BFFは認証済みリクエストを受け取る前提。
*   **汎用APIの提供:** `avion-web` 以外のクライアント (例: モバイルアプリ、外部API) 向けのAPIは提供しない。

## 対象ユーザ

*   Avion Webフロントエンド (`avion-web`)

## ユースケース

### ホームタイムライン表示 (BFF経由)

1.  `avion-web` はログイン後、ホームタイムライン表示に必要なデータを `avion-bff-web` にリクエストする (ページネーション情報、認証JWTを含む)。
2.  `avion-bff-web` はリクエストを受け、`avion-gateway` に認証情報を渡して以下の処理を行う (並列実行も検討):
    *   `avion-timeline` からホームタイムラインのDrop IDリストを取得。
    *   取得したDrop IDに基づき、`avion-post` から各Dropの詳細情報を取得。
    *   各Dropの投稿者IDに基づき、`avion-user` からユーザー情報を取得。
    *   各Drop IDに基づき、`avion-reaction` からリアクション情報を取得。
3.  `avion-bff-web` は取得した情報を集約し、`avion-web` が表示しやすい形式 (例: Dropオブジェクトにユーザー情報やリアクション情報がネストされた配列) に加工する。
4.  加工したデータを `avion-web` に返す。
5.  `avion-web` は受け取ったデータをもとにタイムラインを表示する。

### Drop作成 (BFF経由)

1.  `avion-web` は投稿フォームの内容を `avion-bff-web` に送信する (認証JWTを含む)。
2.  `avion-bff-web` はリクエストを受け、`avion-gateway` 経由で `avion-post` のDrop作成APIを呼び出す。
3.  `avion-post` からのレスポンス (作成されたDropのIDなど) を受け取り、必要であれば加工して `avion-web` に返す。

### SSE接続 (BFF経由の場合 - 検討事項)

1.  `avion-web` は `avion-bff-web` のSSEエンドポイントに接続する。
2.  `avion-bff-web` は内部で `avion-timeline` や `avion-notification` のSSEエンドポイントに接続する (またはイベントキューを購読する)。
3.  バックエンドからイベントを受信したら、`avion-bff-web` は必要に応じて情報を付加・加工し、接続している `avion-web` クライアントにSSEイベントを送信する。

## 機能要求

*   **`avion-web` 専用API:** `avion-web` の画面表示や操作に必要なAPIエンドポイントを定義すること (RESTful API or GraphQL)。
*   **データ集約:** 複数のバックエンドサービスから取得した情報を組み合わせる機能。
*   **データ変換/加工:** バックエンドサービスのデータ構造を、`avion-web` が利用しやすい形式に変換する機能。
*   **バックエンド連携:** `avion-gateway` 経由で各マイクロサービスAPIを呼び出すクライアント機能。

## 技術的要求

### レイテンシ

*   BFF自身の処理による追加レイテンシは最小限に抑えること (例: 平均 50ms 以下)。バックエンドAPI呼び出しのレイテンシが支配的になる。
*   バックエンドAPI呼び出しの並列化などで、トータルのレスポンスタイム短縮を目指す。

### 可用性

*   `avion-web` が機能するために必須となるため、高可用性が求められる。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。

### スケーラビリティ

*   `avion-web` からのリクエスト数に応じて、水平スケールが可能であること。
*   バックエンドサービスへのリクエスト数が適切に管理されていること (N+1問題の回避など)。

### セキュリティ

*   `avion-gateway` から認証済みユーザーの情報を受け取り、バックエンドサービスへのリクエスト時に適切に伝播すること。
*   BFF自体が新たなセキュリティリスクとならないように、入力検証や依存関係管理を行うこと。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。`avion-web` からのトレースコンテキストを受け取り、`avion-gateway` へのリクエスト時に伝播すること。
*   **言語選定:** Go または TypeScript (Node.js) を検討。フロントエンドとの親和性 (TypeScript) vs バックエンドとの一貫性・パフォーマンス (Go) のトレードオフを考慮。

## 決まっていないこと

*   **実装言語:** Go か TypeScript (Node.js) か。
*   **API仕様:** `avion-web` との間でどのようなAPI (REST, GraphQL) を定義するか。
*   **SSEの扱い:** BFFがSSEストリームをプロキシするか、`avion-web` が直接バックエンドのSSEエンドポイントに接続するか。
*   **キャッシュ戦略:** BFF層でどの程度データをキャッシュするか。
*   **エラーハンドリング:** バックエンドサービスのエラーをどのように集約・変換して `avion-web` に返すか。
