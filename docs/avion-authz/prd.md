# PRD: avion-authz

## 概要

Avionにおける認可（Authorization）機能を提供するマイクロサービスを実装する。ユーザー（人間およびBot）が特定のリソースに対してどのような操作（読み取り、書き込み、削除など）を実行できるかを決定する責務を持つ。

## 背景

ユーザーアカウント管理 (`avion-user`) から認可ロジックを分離することで、より柔軟でスケーラブルな権限管理システムを構築する。特に、人間ユーザーだけでなく、APIを利用するBotユーザー（アプリケーション）の導入を考慮すると、それぞれの権限を細かく制御する必要性が高まる。認可ロジックを一元化することで、ポリシーの変更や監査が容易になり、セキュリティも向上する。

## Scientific Merits

*   **関心の分離:** 認証 (`avion-user`) と認可 (`avion-authz`) を明確に分離することで、各サービスの責務が単純化され、開発・保守性が向上する。
*   **柔軟な権限管理:** ユーザー種別（人間/Bot）、ロール、スコープなどに基づいた複雑な認可ポリシーを実装しやすくなる。Botユーザーごとに異なる権限を付与することが可能になる。
*   **セキュリティ向上:** 認可ロジックが一元管理されるため、権限昇格などの脆弱性を減らし、監査も容易になる。
*   **スケーラビリティ:** 認可チェックの負荷に応じて、`avion-authz` サービスを独立してスケールさせることが可能。

Botユーザーの導入や将来的な権限モデルの拡張を考慮すると、認可サービスを独立させるメリットは大きい。

## Design Doc

後で書く

## 参考ドキュメント

*   [Avion アーキテクチャ概要](./../architecture.md)
*   OAuth 2.0 / OpenID Connect (認可コードフロー、クライアントクレデンシャルフローなどを参考に)
*    Zanzibar / Policy Engine (例: OPA - Open Policy Agent) (将来的な高度化の参考)

## 製品原則

*   **最小権限の原則:** ユーザー（人間/Bot）には、タスク実行に必要な最小限の権限のみを付与する。
*   **明確なポリシー:** 誰が何に対して何ができるか、という認可ポリシーが明確に定義・管理されていること。
*   **高速な判定:** 認可チェックのリクエストに対して、迅速に応答すること。

## やること/やらないこと

### やること

*   **認可判定APIの提供:**
    *   リクエスト元ユーザー (ID、種別、ロール/スコープなど)、対象リソース、要求されるアクションを受け取り、許可/拒否を判定するAPI。
*   **Botユーザー (アプリケーション) の管理:**
    *   ユーザーが自身のBotユーザー (クライアントアプリケーション) を登録・管理する機能 (APIキー/シークレットの発行・失効など)。これは `avion-user` と連携する可能性あり。
    *   Botユーザーごとに許可されるスコープ (権限範囲) を定義・管理する。
*   **スコープ/ロール管理:**
    *   システム内で定義される権限スコープ (例: `read:timeline`, `write:post`, `admin:user`) やロールを管理する。
*   **ポリシー定義:** 認可ルール (ポリシー) を定義・管理する仕組み (初期はコード内定義や設定ファイルでも可、将来的にはOPA等も検討)。
*   **トークン検証 (限定的):** API Gatewayから渡されるJWTなどのトークンに含まれるユーザー情報やスコープ情報を利用して認可判定を行う (トークン発行自体は `avion-user` が担当)。

### やらないこと

*   **認証 (Authentication):** ユーザーが誰であるかの確認は `avion-user` が担当する。`avion-authz` は認証されたユーザー情報を受け取る前提。
*   **ユーザー/Botアカウントの永続化:** アカウント情報自体は `avion-user` が管理する。
*   **UIの提供:** ユーザー向けの管理画面などは `avion-web` や `avion-user` 側の機能として実装される。
*   **複雑なABAC/ReBAC (初期):** 初期段階では、スコープやシンプルなロールベースのアクセス制御 (RBAC) を中心とし、属性ベース (ABAC) や関係ベース (ReBAC) のような高度なモデルは将来的な検討事項とする。

## 対象ユーザ

*   Avion API Gateway (`avion-gateway`) (認可チェック依頼元)
*   Avion の他のマイクロサービス (必要に応じて認可チェック依頼)
*   Avion 開発者・運用者 (ポリシー管理、Bot管理など)

## ユースケース

### APIリクエスト時の認可チェック

1.  ユーザー (人間 or Bot) がAPIリクエストを `avion-gateway` に送信する。
2.  `avion-gateway` はリクエストを認証し、ユーザーIDや関連情報 (トークン内のスコープなど) を取得する (`avion-user` と連携)。
3.  `avion-gateway` は、リクエストされた操作に必要な権限 (例: `write:post`) を判断し、`avion-authz` に認可判定リクエスト (ユーザー情報、要求権限、対象リソース情報など) を送信する。
4.  `avion-authz` は定義されたポリシーに基づき、リクエストを許可するか拒否するかを判定し、結果を `avion-gateway` に返す。
5.  `avion-gateway` は、許可された場合はバックエンドサービスにリクエストを転送し、拒否された場合はエラー (例: 403 Forbidden) をクライアントに返す。

### Botユーザーの登録とAPIキー発行

1.  人間ユーザーが設定画面で「新しいBotを作成」を選択する。
2.  フロントエンド (`avion-web`) は `avion-gateway` 経由でBot登録リクエストを送信 (おそらく `avion-user` が窓口)。
3.  `avion-user` はBot用のアカウント情報 (内部的なユーザーIDなど) を生成し、`avion-authz` にBot登録と権限スコープ設定を依頼する。
4.  `avion-authz` (または `avion-user`) はAPIキーとシークレットを生成し、安全に保存する。
5.  APIキーとシークレット (初回のみ表示) をフロントエンドに返し、ユーザーに提示する。

### BotユーザーによるAPIアクセス

1.  Botアプリケーションは発行されたAPIキーとシークレットを使用し、`avion-gateway` に対して認証を行う (例: Client Credentials Flow)。
2.  `avion-gateway` は `avion-user` (または `avion-authz`) と連携して認証を行い、Botユーザーに対応するアクセストークン (スコープ情報を含む) を発行する。
3.  Botアプリケーションはそのアクセストークンを使ってAPIリクエストを行う。
4.  `avion-gateway` はトークンを検証し、トークン内のスコープ情報とリクエスト内容に基づき、`avion-authz` に認可判定を依頼する (上記「APIリクエスト時の認可チェック」と同様)。

## 機能要求

*   **認可判定API:** ユーザー識別子、要求アクション、対象リソース識別子を受け取り、許可/拒否を返すAPI。
*   **ポリシー管理:** 認可ルールを定義・管理できること (初期は設定ファイルやコード内定義でも可)。
*   **スコープ/ロール定義:** システム内で使用される権限スコープやロールを定義できること。
*   **Bot/クライアント管理:** Botユーザー (クライアントアプリケーション) の登録、APIキー/シークレット管理、スコープ割り当て機能 (API経由)。

## 技術的要求

### レイテンシ

*   認可判定API: 平均 50ms 以下 (キャッシュ活用時)。API Gatewayからの同期呼び出しが多いため、低レイテンシが重要。

### 可用性

*   認可判定APIは極めて高い可用性が求められる。これが停止すると多くのAPIが利用不可になる。Kubernetes上での運用を前提とし、複数レプリカによる冗長構成をとる。

### スケーラビリティ

*   APIリクエスト数に応じて認可判定APIの処理能力をスケールできること。
*   ポリシーやロール/スコープ情報の読み込みがボトルネックにならないこと (キャッシュ活用)。

### セキュリティ

*   認可ポリシーへの不正な変更を防ぐこと。
*   BotのAPIキー/シークレットを安全に管理すること。
*   認可判定ロジックに脆弱性がないこと。

### その他技術要件

*   **ステートレス:** サービス自体は状態を持たず、水平スケールが可能であること。ポリシーやクライアント情報はDBや設定から読み込む。
*   **Observability:** OpenTelemetry SDKを導入し、トレース・メトリクス・ログを出力可能にすること。API Gatewayからトレースコンテキストを受け取り、伝播すること。

## 決まっていないこと

*   認可ポリシーの具体的な表現形式と管理方法 (初期実装)。
*   使用するロール/スコープの具体的な定義。
*   Botユーザー (クライアントアプリケーション) の詳細な管理フローと `avion-user` との連携方法。
*   将来的なOPAなどのポリシーエンジン導入の是非とタイミング。
*   認可判定結果のキャッシュ戦略。
